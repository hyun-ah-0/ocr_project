<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¹´ë“œ ëª…ì„¸ì„œ OCR ë¶„ì„ ì„œë¹„ìŠ¤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9ff;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }

        .upload-area.dragover {
            border-color: #764ba2;
            background: #e8ebff;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 4em;
            margin-bottom: 20px;
            color: #667eea;
        }

        .upload-text {
            font-size: 1.2em;
            color: #333;
            margin-bottom: 10px;
        }

        .upload-hint {
            font-size: 0.9em;
            color: #666;
        }

        #fileInput {
            display: none;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .preview-image {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            margin-top: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .loading {
            text-align: center;
            padding: 40px;
            display: none;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results {
            display: none;
        }

        .results.active {
            display: block;
        }

        .section-title {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .transaction-item {
            background: #f8f9ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .transaction-item h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .transaction-detail {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
        }

        .detail-value {
            font-size: 1.1em;
            color: #333;
            font-weight: 600;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .summary-card h3 {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .summary-card .value {
            font-size: 2em;
            font-weight: bold;
        }

        .llm-summary {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #764ba2;
            line-height: 1.8;
            color: #333;
            font-size: 1.05em;
        }
        
        .llm-summary strong {
            font-weight: 700;
            color: #667eea;
        }

        .category-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            margin-top: 5px;
            min-width: 80px;
            text-align: center;
        }

        .category-ì‹ë¹„ { background: #f87171; color: white; }
        .category-ì¹´í˜ê°„ì‹ { background: #45cfd1; color: white; }
        .category-ì‡¼í•‘ { background: #457ed1; color: white; }
        .category-êµí†µ { background: #f9ca24; color: #333; }
        .category-ìƒí™œê³µê³¼ê¸ˆ { background: #6c5ce7; color: white; }
        .category-ì´ì²´ { background: #a78bfa; color: white; }
        .category-ê¸°íƒ€ { background: #cf5198; color: white; }
        .category-ìˆ˜ì… { background: #95a5a6; color: white; }

        .category-chart {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .chart-title {
            font-size: 1.3em;
            color: #333;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .chart-item {
            margin-bottom: 20px;
        }

        .chart-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .chart-category-name {
            font-weight: 600;
            color: #333;
            font-size: 0.95em;
        }

        .chart-amount {
            font-weight: 600;
            color: #667eea;
            font-size: 0.95em;
        }

        .chart-bar-container {
            width: 100%;
            height: 28px;
            background: #f0f0f0;
            border-radius: 14px;
            overflow: hidden;
            position: relative;
        }

        .chart-bar {
            height: 100%;
            border-radius: 14px;
            transition: width 0.6s ease;
            display: flex;
            align-items: center;
            padding: 0 12px;
            box-sizing: border-box;
            position: relative;
        }

        .chart-bar-text {
            color: white;
            font-size: 0.85em;
            font-weight: 600;
            white-space: nowrap;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #c33;
            margin-top: 20px;
            display: none;
        }

        .error.active {
            display: block;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }

            .card {
                padding: 20px;
            }

            .upload-area {
                padding: 30px 20px;
            }

            .summary-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ’³ ì¹´ë“œ ëª…ì„¸ì„œ OCR ë¶„ì„</h1>
            <p>VLM OCRì„ ì‚¬ìš©í•œ ìŠ¤ë§ˆíŠ¸í•œ ì¹´ë“œ ë‚´ì—­ ë¶„ì„ ì„œë¹„ìŠ¤</p>
        </div>

        <div class="card">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">ğŸ“¸</div>
                <div class="upload-text">ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</div>
                <div class="upload-hint">PNG, JPG, JPEG í˜•ì‹ ì§€ì› (ì—¬ëŸ¬ ì´ë¯¸ì§€ ì„ íƒ ê°€ëŠ¥)</div>
                <input type="file" id="fileInput" accept="image/*" multiple>
            </div>
            <div id="previewContainer" style="display: none; margin-top: 20px;"></div>
            <button class="btn" id="analyzeBtn" style="display: none;" disabled>ë¶„ì„ ì‹œì‘</button>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
            </div>

            <div class="error" id="error"></div>
        </div>

        <div class="results" id="results">
            <div class="card">
                <h2 class="section-title">ğŸ“Š ìš”ì•½ ì •ë³´</h2>
                <div class="summary-grid" id="summaryGrid"></div>
                <div class="llm-summary" id="llmSummary"></div>
            </div>

            <div class="card">
                <h2 class="section-title">ğŸ’¼ ê±°ë˜ ë‚´ì—­</h2>
                <div id="transactionsList"></div>
            </div>
        </div>
    </div>

    <script>
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const previewContainer = document.getElementById('previewContainer');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');
        const errorDiv = document.getElementById('error');
        const transactionsList = document.getElementById('transactionsList');
        const summaryGrid = document.getElementById('summaryGrid');
        const llmSummary = document.getElementById('llmSummary');

        let selectedFiles = [];

        // íŒŒì¼ ì„ íƒ ì´ë²¤íŠ¸
        uploadArea.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileSelect);

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            handleFiles(files);
        });

        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            if (files.length > 0) {
                handleFiles(files);
            }
        }

        function handleFiles(files) {
            // ì´ë¯¸ì§€ íŒŒì¼ë§Œ í•„í„°ë§
            const imageFiles = files.filter(file => file.type.startsWith('image/'));
            
            if (imageFiles.length === 0) {
                showError('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                return;
            }

            selectedFiles = imageFiles;
            previewContainer.innerHTML = '';
            previewContainer.style.display = 'block';
            
            // ê° ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ìƒì„±
            imageFiles.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const imgWrapper = document.createElement('div');
                    imgWrapper.style.cssText = 'margin-bottom: 10px; position: relative; display: inline-block; margin-right: 10px;';
                    
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.cssText = 'max-width: 200px; max-height: 200px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);';
                    
                    const label = document.createElement('div');
                    label.textContent = `${index + 1}. ${file.name}`;
                    label.style.cssText = 'font-size: 0.85em; color: #666; margin-top: 5px; text-align: center;';
                    
                    imgWrapper.appendChild(img);
                    imgWrapper.appendChild(label);
                    previewContainer.appendChild(imgWrapper);
                };
                reader.readAsDataURL(file);
            });

            analyzeBtn.style.display = 'block';
            analyzeBtn.disabled = false;
            results.classList.remove('active');
            errorDiv.classList.remove('active');
        }

        // ë¶„ì„ ì‹œì‘
        analyzeBtn.addEventListener('click', async () => {
            if (selectedFiles.length === 0) return;

            loading.classList.add('active');
            analyzeBtn.disabled = true;
            results.classList.remove('active');
            errorDiv.classList.remove('active');

            try {
                let allTransactions = [];
                let allSummaries = [];
                
                // ì—¬ëŸ¬ íŒŒì¼ì´ ìˆìœ¼ë©´ ì—¬ëŸ¬ íŒŒì¼ ì—”ë“œí¬ì¸íŠ¸ ì‚¬ìš©, í•˜ë‚˜ë©´ ë‹¨ì¼ ì—”ë“œí¬ì¸íŠ¸ ì‚¬ìš©
                if (selectedFiles.length > 1) {
                    const formData = new FormData();
                    selectedFiles.forEach((file, index) => {
                        formData.append('files', file);
                    });

                    const response = await fetch('/api/analyze-multiple', {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || 'ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    }

                    const data = await response.json();
                    displayResults(data);
                } else {
                    // ë‹¨ì¼ íŒŒì¼ ì²˜ë¦¬
                    const formData = new FormData();
                    formData.append('file', selectedFiles[0]);

                    const response = await fetch('/api/analyze', {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || 'ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    }

                    const data = await response.json();
                    displayResults(data);
                }
                
            } catch (error) {
                console.error('Error details:', error);
                let errorMessage = error.message;
                if (error.message === 'Failed to fetch') {
                    errorMessage = 'ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. FastAPI ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”. (uvicorn main:app --reload)';
                }
                showError(`ì˜¤ë¥˜: ${errorMessage}`);
            } finally {
                loading.classList.remove('active');
                analyzeBtn.disabled = false;
            }
        });

        function displayResults(data) {
            // ìš”ì•½ ì •ë³´ í‘œì‹œ
            const summary = data.summary;
            summaryGrid.innerHTML = `
                <div class="summary-card">
                    <h3>ì´ ì§€ì¶œ</h3>
                    <div class="value">${formatCurrency(summary.total_spent || 0)}</div>
                </div>
                <div class="summary-card">
                    <h3>ì´ ìˆ˜ì…/í™˜ë¶ˆ</h3>
                    <div class="value">${formatCurrency(summary.total_income || 0)}</div>
                </div>
                <div class="summary-card">
                    <h3>ê±°ë˜ ê±´ìˆ˜</h3>
                    <div class="value">${data.transactions.length}ê±´</div>
                </div>
            `;

            // ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ ë§‰ëŒ€ ê·¸ë˜í”„ ì¶”ê°€
            if (summary.by_category_expense) {
                const categories = Object.entries(summary.by_category_expense);
                
                // ê¸ˆì•¡ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬ (ë‚´ë¦¼ì°¨ìˆœ)
                categories.sort((a, b) => {
                    const amountA = typeof a[1] === 'object' && a[1] !== null ? a[1].amount : a[1];
                    const amountB = typeof b[1] === 'object' && b[1] !== null ? b[1].amount : b[1];
                    return (amountB || 0) - (amountA || 0);
                });

                // ìµœëŒ€ ê¸ˆì•¡ ì°¾ê¸° (100% ê¸°ì¤€)
                const maxAmount = Math.max(...categories.map(([_, data]) => {
                    return typeof data === 'object' && data !== null ? data.amount : data;
                }));

                // ë§‰ëŒ€ ê·¸ë˜í”„ ì»¨í…Œì´ë„ˆ ìƒì„±
                const chartContainer = document.createElement('div');
                chartContainer.className = 'category-chart';
                chartContainer.innerHTML = '<div class="chart-title">ğŸ“Š ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ í˜„í™©</div>';

                categories.forEach(([category, data]) => {
                    // dataëŠ” {amount: number, ratio: number} í˜•íƒœ
                    const amount = typeof data === 'object' && data !== null ? data.amount : data;
                    const ratio = typeof data === 'object' && data !== null ? data.ratio : (maxAmount > 0 ? (amount / maxAmount) * 100 : 0);
                    const categoryClass = category.replace(/\//g, '');
                    
                    // ë§‰ëŒ€ ë¹„ìœ¨ ê³„ì‚° (ìµœëŒ€ê°’ ëŒ€ë¹„)
                    const barWidth = maxAmount > 0 ? (amount / maxAmount) * 100 : 0;
                    
                    // ì¹´í…Œê³ ë¦¬ë³„ ìƒ‰ìƒ ë§¤í•‘
                    const categoryColors = {
                        'ì‹ë¹„': '#f87171',
                        'ì¹´í˜ê°„ì‹': '#45cfd1',
                        'ì‡¼í•‘': '#457ed1',
                        'êµí†µ': '#f9ca24',
                        'ìƒí™œê³µê³¼ê¸ˆ': '#6c5ce7',
                        'ì´ì²´': '#a78bfa',
                        'ê¸°íƒ€': '#cf5198',
                        'ìˆ˜ì…': '#95a5a6'
                    };
                    
                    const barColor = categoryColors[categoryClass] || '#95a5a6';
                    
                    const chartItem = document.createElement('div');
                    chartItem.className = 'chart-item';
                    chartItem.innerHTML = `
                        <div class="chart-label">
                            <span class="chart-category-name">${category}</span>
                            <span class="chart-amount">${formatCurrency(amount || 0)}</span>
                        </div>
                        <div class="chart-bar-container">
                            <div class="chart-bar" style="width: ${barWidth}%; background: ${barColor};">
                                <span class="chart-bar-text">${formatCurrency(amount || 0)}</span>
                            </div>
                        </div>
                    `;
                    chartContainer.appendChild(chartItem);
                });

                // summaryGrid ë‹¤ìŒì— ë§‰ëŒ€ ê·¸ë˜í”„ ì¶”ê°€
                summaryGrid.parentElement.insertBefore(chartContainer, summaryGrid.nextSibling);
            }

            // LLM ìš”ì•½ í‘œì‹œ (bold ì²˜ë¦¬ ë° ë¦¬ìŠ¤íŠ¸ í˜•ì‹ í¬í•¨)
            const summaryText = data.llm_summary || 'ìš”ì•½ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.';
            // ì¤„ë°”ê¿ˆ ì²˜ë¦¬ ë° **ë¡œ ê°ì‹¸ì§„ í…ìŠ¤íŠ¸ë¥¼ <strong> íƒœê·¸ë¡œ ë³€í™˜
            let formattedText = summaryText
                .split('\n')
                .map(line => {
                    // "- "ë¡œ ì‹œì‘í•˜ëŠ” ì¤„ì€ ê·¸ëŒ€ë¡œ ìœ ì§€í•˜ê³ , **ë¥¼ <strong>ìœ¼ë¡œ ë³€í™˜
                    line = line.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                    return line;
                })
                .join('<br>');
            llmSummary.innerHTML = formattedText;

            // ê±°ë˜ ë‚´ì—­ í‘œì‹œ
            transactionsList.innerHTML = '';
            if (data.transactions && data.transactions.length > 0) {
                data.transactions.forEach((tx, index) => {
                    const item = document.createElement('div');
                    item.className = 'transaction-item';
                    
                    const category = tx.category_rule || tx.category_mm || 'ë¯¸ë¶„ë¥˜';
                    const categoryClass = category.replace(/\//g, '');
                    
                    item.innerHTML = `
                        <h3>ê±°ë˜ #${index + 1}</h3>
                        <div class="transaction-detail">
                            <div class="detail-item">
                                <span class="detail-label">ë‚ ì§œ</span>
                                <span class="detail-value">${tx.date || 'N/A'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">ìƒí˜¸ëª…</span>
                                <span class="detail-value">${tx.merchant || 'N/A'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">ê¸ˆì•¡</span>
                                <span class="detail-value">${tx.amount || 'N/A'}</span>
                            </div>
                            <div class="detail-item" style="width: 100%;">
                                <span class="detail-label">ì¹´í…Œê³ ë¦¬</span>
                                <div style="margin-top: 8px;">
                                    <span class="category-badge category-${categoryClass}">${category}</span>
                                </div>
                            </div>
                        </div>
                    `;
                    transactionsList.appendChild(item);
                });
            } else {
                transactionsList.innerHTML = '<p>ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            }

            results.classList.add('active');
        }

        function formatCurrency(amount) {
            if (typeof amount === 'string') {
                return amount;
            }
            return new Intl.NumberFormat('ko-KR').format(amount) + 'ì›';
        }

        function showError(message) {
            errorDiv.textContent = message;
            errorDiv.classList.add('active');
        }
    </script>
</body>
</html>

